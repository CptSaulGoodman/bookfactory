<!-- Bookshelf Template -->
<div class="bookshelf">
    <div class="bookshelf-filters">
        <form hx-get="/bookshelf" hx-target="#bookshelf-content" hx-trigger="change" hx-select="#bookshelf-content">
            <label class="filter-checkbox">
                <input type="radio" name="status" value="active" checked>
                <span>{{ _('filter_active') }}</span>
            </label>
            <label class="filter-checkbox">
                <input type="radio" name="status" value="draft">
                <span>{{ _('filter_drafts') }}</span>
            </label>
        </form>
    </div>
    
    <div id="bookshelf-content" class="books-list">
        {% if books %}
            <ul>
                {% for book in books %}
                <li class="book-item" id="book-{{ book.id }}">
                    <a href="{% if book.status == 'active' %}/book/{{ book.id }}{% else %}/book/new{% endif %}" class="book-title">
                        {{ book.title }}
                    </a>
                    <div class="book-actions">
                        <div class="dropdown">
                            <button class="dropdown-toggle">...</button>
                            <div class="dropdown-menu">
                                <button class="dropdown-item delete-book-btn" 
                                        data-book-id="{{ book.id }}"
                                        data-book-title="{{ book.title }}">
                                    {{ _('delete') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="no-books">{{ _('no_books_found') }}</p>
        {% endif %}
    </div>
    
    <div class="new-book-button-container">
        <button class="theme-switcher" id="theme-switcher" aria-label="Toggle theme">
            <svg class="icon icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <circle cx="12" cy="12" r="5"/>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            <svg class="icon icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        </button>        

        <a href="/book/new" class="new-book-button">
            <span class="new-book-text">{{ _('new_book') }}</span>
            <span class="new-book-icon">+</span>
        </a>
    </div>
</div>

<!-- Confirmation Dialog -->
<div id="delete-confirmation-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>{{ _('confirm_delete') }}</h3>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>{{ _('delete_book_warning') }} "<span id="book-title-to-delete"></span>"?</p>
            <p class="warning-text">{{ _('delete_warning_permanent') }}</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-delete">{{ _('cancel') }}</button>
            <button class="btn btn-danger" id="confirm-delete">{{ _('delete') }}</button>
        </div>
    </div>
</div>

<script>
    (function() {
        // Theme switcher functionality
        const themeSwitcher = document.getElementById('theme-switcher');
        const html = document.documentElement;

        // Get saved theme from localStorage or system preference
        const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        html.setAttribute('data-theme', currentTheme);

        themeSwitcher.addEventListener('click', () => {
            const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // Delete confirmation functionality
        const modal = document.getElementById('delete-confirmation-modal');
        const modalClose = document.getElementById('modal-close');
        const cancelBtn = document.getElementById('cancel-delete');
        const confirmBtn = document.getElementById('confirm-delete');
        const bookTitleSpan = document.getElementById('book-title-to-delete');
        
        let currentBookId = null;
        let currentBookElement = null;

        // Show modal when delete button is clicked
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-book-btn')) {
                e.preventDefault();
                currentBookId = e.target.getAttribute('data-book-id');
                const bookTitle = e.target.getAttribute('data-book-title');
                currentBookElement = document.getElementById(`book-${currentBookId}`);
                
                bookTitleSpan.textContent = bookTitle;
                modal.style.display = 'flex';
            }
        });

        // Close modal functions
        function closeModal() {
            modal.style.display = 'none';
            currentBookId = null;
            currentBookElement = null;
        }

        modalClose.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        // Close modal when clicking outside
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });

        // Handle delete confirmation
        confirmBtn.addEventListener('click', function() {
            if (currentBookId && currentBookElement) {
                // Create HTMX request to delete the book
                htmx.ajax('DELETE', `/book/${currentBookId}`, {
                    target: `#book-${currentBookId}`,
                    swap: 'outerHTML'
                });
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                closeModal();
            }
        });
    })();
</script>
